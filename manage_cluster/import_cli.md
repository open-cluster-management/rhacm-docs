# Importing a managed cluster with the CLI


After you install Red Hat Advanced Cluster Management for Kubernetes, you are ready to import a cluster to manage.


  - [Prerequisites](#prerequisites)
  - [Supported architecture](#supported-architecture)
  - [Prepare for import](#prepare-for-import)
  - [Importing the multicluster-endpoint](#importing-the-multicluster-endpoint)
    
  **Note:** A hub cluster cannot manage another hub cluster.
    
## Prerequisites

* You must have an Red Hat Advanced Cluster Management for Kubernetes hub cluster that is deployed and separate cluster that you want to manage.

* Your Red Hat OpenShift Container Platform CLI must be version 4.3, or later, and configured to run `oc` commands. See [Getting started with the CLI](https://docs.openshift.com/container-platform/4.3/cli_reference/openshift_cli/getting-started-cli.html) for information about installing and configuring the Red Hat OpenShift CLI, `oc`.

* You need to install the Kubernetes CLI, `kubectl`. To install `kubectl`, see _Install and Set Up kubectl_ in the [Kubernetes documentation](https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-on-macos).

  **Note:** Download the installation file for CLI tools from the console.

## Supported architecture

* Linux
* macOS

## Prepare for import

1. Log in to your _hub cluster_. Run the following command:
   
  ```
  oc login
  ```

2. Run the following command on the hub cluster to create the `oc create ns <cluster_namespace>` namespace:

  ```
  oc create -n ${CLUSTER_NAMESPACE} secret docker-registry quay-secret --docker-server=quay.io --docker-username=${DOCKER_USER} --docker-password=${DOCKER_PASS}
  ```
  
3. Edit the example ClusterRegistry cluster with the following sample of YAML:

  ```
  apiVersion: clusterregistry.k8s.io/v1alpha1
  kind: Cluster
  metadata:
    labels:
      cloud: auto-detect
      name: <cluster_namespace>
      vendor: auto-detect
    name: <cluster_namespace>
    namespace: <cluster_namespace>
  spec: {}
  ```


4. Apply the ClusterRegistry cluster with the following command: <!-- I added this step to apply, please confirm (we didn't have one in the draft)-->

  ```
  oc apply -f <file-name.yaml>
  ```
   
5. Create the endpoint configuration. Enter the following example YAML:

  ```
  apiVersion: multicloud.ibm.com/v1alpha1
  kind: EndpointConfig
  metadata:
    name: <cluster_namespace>
    namespace: <cluster_namespace>
  spec:
    applicationManager:
      enabled: true
    clusterLabels:
      cloud: auto-detect
      vendor: auto-detect
    clusterName: <cluster_namespace>
    clusterNamespace: <cluster_namespace>
    connectionManager:
      enabledGlobalView: false
    imageRegistry: quay.io/open-cluster-management
    imagePullSecret: quay-secret
    policyController:
      enabled: true
    searchCollector:
      enabled: true
    serviceRegistry:
      enabled: true
    certPolicyController:
      enabled: true
    cisController:
      enabled: true
    iamPolicyController:
      enabled: true
    version: 1.0.0
  ```
6. Create a Multicloud EndpointConfig. Run the following command: 

  ```
  oc apply -f test_endpoint_config.yaml
  ```

The ClusterController takes the following actions:

- EndpointConfig creation triggers `Reconcile()` in [/pkg/controllers/endpointconfig/endpointconfig_controller.go](https://github.com/open-cluster-management/rcm-controller/blob/master/pkg/controller/endpointconfig/endpointconfig_controller.go).
  
- Controller uses information in EndpointConfig to generate a secret named `{cluster-name}-import`.
  
- The `{cluster-name}-import` secret contains the `import.yaml` that the user applies to a managed cluster to install `multicluster-endpoint`.

## Importing the multicluster-endpoint

1. Obtain the `endpoint-crd.yaml` that was generated by the cluster controller.

  For macOS, run the following command:

  ```bash
  kubectl get secret ${cluster_name}-import -n ${cluster_namespace} -o jsonpath={.data.endpoint-crd\\.yaml} | base64 --decode > endpoint-crd.yaml
  ```

2. Obtain the `import.yaml` that was generated by the cluster controller.

  ```bash
  kubectl get secret ${cluster_name}-import -n ${cluster_namespace} -o jsonpath={.data.import\\.yaml} | base64 --decode > import.yaml
  ```

3. Log in to your target managed cluster.
  
4. Apply the `import.yaml` generated in previous step. Run the following commands:
  
  ```
  kubectl apply -f endpoint-crd.yaml
  ```

5. Validate the pod status on the target managed cluster. Run the following command:
   
  ```
  kubectl get pod -n multicluster-endpoint
  ```

  ```
  kubectl apply -f import.yaml
  ```

6. Check the cluster on the hub cluster. Run the following command:
   
   ```
   kubectl get cluster --all-namespaces
   ```
