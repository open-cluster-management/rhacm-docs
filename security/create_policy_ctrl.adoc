[#managing-custom-policy-controllers]
= Managing custom policy controllers

Learn to create, apply, view, and update your custom policy controllers.

[#creating-a-custom-policy-controller]
== Creating a custom policy controller

You can create a YAML file for your policy controller from the command line interface (CLI) to deploy the controller to your cluster.
View the following sections to create a policy controler:

[#creating-a-policy-controller-from-the-cli]
=== Creating a policy controller from the CLI

Use the policy controller framework that is in the link:https://github.com/open-cluster-management/multicloud-operators-policy-controller[`multicloud-operators-policy-controller`] repository:

Complete the following steps to create a policy controller from the CLI:

. Clone the `multicloud-operators-policy-controller` repository by running the following command:
+
---
git clone git@github.com:open-cluster-management/multicloud-operators-policy-controller.git
---

. Customize the controller policy by updating the policy schema definition. Your policy might resemble the following content:
+
---
metadata: 
  name: samplepolicies.policies.open-cluster-management.io
spec:
  group: policy.open-cluster-management.io
  names:
    kind: SamplePolicy
    listKind: SamplePolicyList
    plural: samplepolicies
    singular: samplepolicy
---

Your policy controller is created.


[#viewing-your-policy-controller-yaml-file-from-the-console]
==== Viewing your policy controller YAML file from the console

// verify that this is possible
You can view any policy controller and its status from the console.

. Log in to your cluster from the console.
. From the navigation menu, click *Governance and risk* to view a table list of your policies.
+
NOTE: You can filter the table list of your policies by selecting the _All policies_ tab or _Cluster violations_ tab.

. Select one of your policies to view more details.
. View a specific policy controller policy violations by selecting the _Violations_ tab.

[#updating-policy-controllers]
== Updating policy controllers

Update the schema definition for the controller by completing the following steps:

. Log in to your cluster.
.. Select the user icon, then click **Configure client**.
.. Copy and paste the configuration information into your command line, and press **Enter**.
.. Run the following commands to apply your policy CRD and start the controller:
   
   +
   ---
   export GO111MODULE=on
   
   kubectl apply -f deploy/crds/policy.open-cluster-management.io_samplepolicies_crd.yaml
   
   operator-sdk run --local --verbose
   ---

   When the policy is applied, a message appears to indicate that policy is monitored and detected by your custom controller. The mesasge might resemble the following contents:
   
   +
   ---
   {"level":"info","ts":1578503685.643426,"logger":"controller_samplepolicy","msg":"Reconciling SamplePolicy","Request.Namespace":"default","Request.Name":"example-samplepolicy"}
   {"level":"info","ts":1578503685.855259,"logger":"controller_samplepolicy","msg":"Reconciling SamplePolicy","Request.Namespace":"default","Request.Name":"example-samplepolicy"}
   Available policies in namespaces: 
   namespace = kube-public; policy = example-samplepolicy 
   namespace = default; policy = example-samplepolicy 
   namespace = kube-node-lease; policy = example-samplepolicy
   ---

. Verify a list of the policies by running the following command:
+
----
kubectl get samplepolicy example-samplepolicy -oyaml
----

. Check the `status` field for compliance details. Your output might resemble the following contents:

[source,yaml]
---
status:
  compliancyDetails:
    example-samplepolicy:
      cluster-wide:
      - 5 violations detected in namespace `cluster-wide`, there are 0 users violations
        and 5 groups violations
      default:
      - 0 violations detected in namespace `default`, there are 0 users violations
        and 0 groups violations
      kube-node-lease:
      - 0 violations detected in namespace `kube-node-lease`, there are 0 users violations
        and 0 groups violations
      kube-public:
      - 1 violations detected in namespace `kube-public`, there are 0 users violations
        and 1 groups violations
  compliant: NonCompliant
---

Your policy controller YAML file is updated.

[#updating-policy-rules]
=== Updating policy rules

Update the policy rules and policy logic by completing the following steps:

. Add new fields in your YAML file to introduce new rules for your policy controller.
. Update the `SamplePolicySpec` with new fields. Your specification might resemble the following content:

[source,yaml]
---
spec:
  description: SamplePolicySpec defines the desired state of SamplePolicy
  properties:
    labelSelector:
      additionalProperties:
        type: string
      type: object
    maxClusterRoleBindingGroups:
      type: integer
    maxClusterRoleBindingUsers:
      type: integer
    maxRoleBindingGroupsPerNamespace:
      type: integer
    maxRoleBindingUsersPerNamespace:
      type: integer
---

. Update the `PeriodicallyExecSamplePolicies` function in the `samplepolicy_controller.go` file. View an example of the `PeriodicallyExecSamplePolicies` field, see link:https://github.com/open-cluster-management/multicloud-operators-policy-controller/blob/master/pkg/controller/samplepolicy/samplepolicy_controller.go#L208[open-cluster-management/multicloud-operators-policy-controller]


[#deleting-a-policy-controller]
=== Deleting a policy controller

Delete the policy controller from the CLI.

* Delete a policy controller from the CLI:
 .. Delete a policy controller by running the following command:
// verify command `namespace`
+
----
kubectl delete policy <policy-name> -n <open-cluster-management-namespace>
----
+
After your policy is deleted, it is removed from your target cluster or clusters.

 .. Verify that your policy is removed by running the following command:
+
----
kubectl get policy <policy-name> -n <open-cluster-management-namespace>
----

Your policy controller is deleted.

View a sample of a certificate policy, see _Certificate policy sample_ on the xref:../security/cert_policy_ctrl.adoc#certificate-policy-sample[Certificate policy controller] page.
For more information about other policy controllers, see xref:../security/policy_controllers.adoc#policy-controllers[Policy controllers].
See xref:../security/create_policy.adoc#managing-security-policies[Managing security policies] to manage other policies.
