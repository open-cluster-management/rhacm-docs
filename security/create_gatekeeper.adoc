[#gatekeeper-policy-integration]
= Integrating Gatekeeper

Use the gatekeeper operator policy to install the gatekeeper operator and gatekeeper on a managed cluster. You can create and configure a Gatekeeper operator policy to monitor customer resources (CR) that are created in the same namespace it is deployed.

*Required access*: Cluster administrator

[#gatekeeper-operator-policy]
== Installing gatekeeper using a gatekeeper operator policy

Use the governance framework to install the gatekeeper operator. Gatekeeper operator is available in the OpenShift Container Platform catalog. See _Adding Operators to a cluster_ in the link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.6/html/operators/administrator-tasks#olm-adding-operators-to-a-cluster[OpenShift Container Platform documentation] for more information.

Gatekeeper operator policy is monitored by the Red Hat Advanced Cluster Management configuration policy controller, where `enforce` remediation action is supported. Gatekeeper operator policies are created automatically by the controller when set to `enforce`.

Complete the following steps to install the gatekeeper operator policy from the console:

. Log in to your cluster.
. From the navigation menu, click *Govern risk*.
. Create a policy by selecting *Create policy*.
. As you complete the form, select *GatekeeperOperator* from the _Specifications_ field. The parameter values for your policy are automatically populated and the policy is set to enforce to install Gatekeeper.


[#creating-a-gatekeeper-policy]
=== Creating a gatekeeper policy

You can create a YAML file for your gatekeeper policy from the command line interface (CLI). The {product-title} configuration policy propagates the gatekeeper policy from the hub cluster to the managed cluster. 

View the following resource component examples that are required to create a gatekeeper policy:

* link:https://github.com/open-cluster-management/policy-collection/blob/master/community/CM-Configuration-Management/policy-gatekeeper-sample.yaml#L21-L65[gatekeeper]: 
+
----
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: templates.gatekeeper.sh/v1beta1
                kind: ConstraintTemplate
                metadata:
                  name: k8srequiredlabels
                spec:
                  crd:
                    spec:
                      names:
                        kind: K8sRequiredLabels
                      validation:
                        # Schema for the `parameters` field
                        openAPIV3Schema:
                          properties:
                            labels:
                              type: array
                              items: string
                  targets:
                    - target: admission.k8s.gatekeeper.sh
                      rego: |
                        package k8srequiredlabels
                        violation[{"msg": msg, "details": {"missing_labels": missing}}] {
                          provided := {label | input.review.object.metadata.labels[label]}
                          required := {label | label := input.parameters.labels[_]}
                          missing := required - provided
                          count(missing) > 0
                          msg := sprintf("you must provide labels: %v", [missing])
                        }
            - complianceType: musthave
              objectDefinition:
                apiVersion: constraints.gatekeeper.sh/v1beta1
                kind: K8sRequiredLabels
                metadata:
                  name: ns-must-have-gk
                spec:
                  match:
                    kinds:
                      - apiGroups: [""]
                        kinds: ["Namespace"]
                    namespaces:
                      - e2etestsuccess
                      - e2etestfail
                  parameters:
                    labels: ["gatekeeper"]
----

* link:https://github.com/open-cluster-management/policy-collection/blob/master/community/CM-Configuration-Management/policy-gatekeeper-sample.yaml#L83-L102[admission]: `admission` resource is defined to look for events that are generated by the gatekeeper admission webhook. 
+
[source,yaml]
----
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-gatekeeper-admission
        spec:
          remediationAction: inform # will be overridden by remediationAction in parent policy
          severity: low
          object-templates:
            - complianceType: mustnothave
              objectDefinition:
                apiVersion: v1
                kind: Event
                metadata:
                  namespace: openshift-gatekeeper-system # set it to the actual namespace where gatekeeper is running if different
                  annotations:
                    constraint_action: deny
                    constraint_kind: K8sRequiredLabels
                    constraint_name: ns-must-have-gk
                    event_type: violation
----

* link:https://github.com/open-cluster-management/policy-collection/blob/master/community/CM-Configuration-Management/policy-gatekeeper-sample.yaml#L66-L82[audit]: `audit` resource is defined to periodically checks and evaluates existing resources against the gatekeeper policies
+
[source,yaml]
----
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-gatekeeper-audit
        spec:
          remediationAction: inform # will be overridden by remediationAction in parent policy
          severity: low
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: constraints.gatekeeper.sh/v1beta1
                kind: K8sRequiredLabels
                metadata:
                  name: ns-must-have-gk
                status:
                  totalViolations: 0
----

Use the link:https://github.com/open-cluster-management/policy-collection/blob/master/community/CM-Configuration-Management/policy-gatekeeper-sample.yaml#L12-L65[`gatekeeper-sample.yaml` file] to create a gatekeeper policy. 

For more information about integrating third-party policies with the product, see xref:../security/third_party_policy.adoc#integrate-third-party-policies[Integrate third-party policies]. 

